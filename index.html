<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Pytomate Spatial</title>
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="styles/github-dark.min.css">
	<script src="highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
</head>
<body>
	<header>
		<div class="container head_cont">
			<a class="blog_name" href="index.html">Pytomate<br>Spatial</a>
		</div>
	</header>
	<section class="intro_section">
		<div class="container sec_cont">
			<p class="intro">Greetings fellow geospatial enthusiasts,
			I am Shidharth and I welcome you to my conclave of geospatial awesomeness.
			I have created this blog to share my learnings and findings I have come (will be coming) 
			aross while trying to solve various geospatial problems through automation. I believe
			this blog will serve as a bookmark to my future self and hopefully to others as well.
			</p>
		</div>
	</section>
	
<section class="code">
	<div class="container code_sec_cont">
		<div class="title">
			<h2>1. Reading/Writing GeoTiff Files with "Rasterio"</h2>
			<br>
			<p class="hashtags">#geospatial #python #numpy #rasterio</p>
			<br>
			<div class="code-description">
				<p>Rasterio is one of the most used and easy to implement python module for reading and writing GeoTiff files. The ".read()" method in rasterio yields a
				numpy array which makes it easy to perform complex mathematical calculations on the read 
				raster.
				</p>
			</div>
		</div>
<div class="code-script">
<pre>
<code>
import rasterio

'''
file path should include file name and extension
example input: /home/my_tiffs/in.tif
example output: /home/my_tiffs/out.tif
'''

PATH_RAS_IN = "your input GeoTiff file path"
PATH_RAS_OUT = "your output GeoTiff file path"

def raster_analysis(raster):
	'''
	function to do analysis on the read
	raster
	'''
	# do something with the raster
	return raster

# Read GeoTiff file
with rasterio.open(PATH_RAS_IN) as src:
	profile = src.profile
	raster = src.read()

analysed_ras = raster_analysis(raster)

# Write analysed GeoTiff file
with rasterio.open(PATH_RAS_OUT, 'w', **profile) as dst:
	dst.write(analysed_ras)
</code>
</pre>
</div>
	</div>
</section>

<section class="code">
	<div class="container code_sec_cont">
<div class="code-script">
<pre>
<code>
import geopandas as gpd

'''
file path should include file name and extension
example input: /home/my_shps/in.shp
example output: /home/my_shps/out.shp
'''

PATH_SHP_IN = "your input Vector file path"
PATH_SHP_OUT = "your output Vector file path"

def vector_analysis(gdf):
	'''
	function to do analysis on the
	columns of the read vector file
	'''
	# do something with the vector file
	return gdf

# Read Vector file
gdf = gpd.read_file(PATH_SHP_IN)

analysed_gdf = vector_analysis(gdf)

# Write analysed Vector file
analysed_gdf.to_file(PATH_SHP_OUT)
</code>
</pre>
</div>
	<div class="title">
		<h2>2. Reading/Writing Vector Files with "Geopandas"</h2>
		<br>
		<p class="hashtags">#geospatial #python #pandas #geopandas</p>
		<br>
		<div class="code-description">
			<p>Geopandas is one of the most used python module for vector data analysis.
			The resulatant of the ".read_file()" method in geopandas yields a GeoDataFrame which 
			mimics "pandas" (a popular module in python for handling table type files like csv, 
			xls, xlsx, etc.) DataFrame to some extent making it easy for user to learn and apply 
			most of the functionalities of a common dataframe if they have worked with pandas before.
			</p>
		</div>
	</div>
	</div>
</section>

<section class="code">
	<div class="container code_sec_cont">
		<div class="title">
			<h2>3. Creating GeoTiff from Earth Engine fetched array over a Region</h2>
			<br>
			<p class="hashtags">#geospatial #python #numpy #rasterio #earthengine</p>
			<br>
			<div class="code-description">
				<p>Earth Engine's Python API allows users to use the best of both worlds i.e.,
				combining the power of python modules and speed of Google Earth Engine. I have
				tried creating GeoTiffs in python after calculating a demo index for 
				time-series images over a location using Sentinel-2 dataset in earth engine
				repository.
				</p>
			</div>
		</div>
<div class="code-script">
<pre>
<code>
import ee
import numpy as np
from rasterio.transform import from_origin
import rasterio

BASE_OUT = "your output GeoTiffs folder location"

# Authenticate and Initialize earth engine on your system
ee.Authenticate()
ee.Initialize()

# create earth engine Polygon with coordinates
coords = [[76.883388, 20.627474],
	 [76.885212, 20.627468],
	 [76.885244, 20.626607],
	 [76.883338, 20.626866],
	 [76.883388, 20.627474]]

minx, miny = np.array(coords).min(axis = 0)
maxx, maxy = np.array(coords).max(axis = 0)
AOI = ee.Geometry.Polygon(coords)

# user-defined function section
def index_func(image):
	'''
	calculate index with bands
	can be extended or modified to any index 
	'''
	index_ = image.normalizedDifference(['B1', 'B2'])
	return image.addBands(index_.rename('DEMO_INDEX'))

def get_rectangle(image):
	'''
	clips images with bounding box of AOI
	'''
	return image.sampleRectangle(AOI, defaultValue = -999)

# function for getting image ID
get_id = np.vectorize(lambda x : x['id'][:8])

# function for getting image properties
get_properties = np.vectorize(lambda x : x['properties'])
	
def create_tiffs(minx, maxy, dates, index_array):
	'''
	create tiffs and save on your local system
	'''
	res = 0.00009 # (in degrees)for 10m resolution
	transform = from_origin(minx, maxy, res, res)
	proj = "+proj=longlat +datum=WGS84 +no_defs +type=crs"

	for i in range(len(dates)):
		arr = index_array[i]
		out_tiff = f"{BASE_OUT}{dates[i]}.tif"
		print('creating...\n', out_tiff)
		new_dataset = rasterio.open(out_tiff, 'w', 
						driver = 'GTiff',
						height = arr.shape[0], 
						width = arr.shape[1],
						count = 1, 
						dtype = str(arr.dtype),
						crs = proj,
						transform = transform)

		new_dataset.write(arr, 1)
		new_dataset.close()

'''
calculate DEMO_INDEX for defined time-series images and 
extract calculated images as arrays with ".getInfo()"
max pixel limit = 262144
'''		
date_start = "2022-07-01"
date_end = "2023-01-01"
dataset = (ee.ImageCollection('COPERNICUS/S2_SR')
           .filterBounds(AOI)
           .filterDate(date_start, date_end)
           .map(index_func)
           .select('DEMO_INDEX')
           .map(get_rectangle))
dataset_list = dataset.toList(dataset.size()).getInfo()

# creating and saving GeoTiffs
dates = get_id(dataset_list)
properties = get_properties(dataset_list)
index_array = np.array([np.array(x['DEMO_INDEX']) for x in properties])
index_array[index_array == -999] = np.nan
create_tiffs(minx, maxy, dates, index_array)
</code>
</pre>
</div>
	</div>
</section>

</body>
</html>